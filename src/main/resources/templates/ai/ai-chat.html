<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/user/head :: head}"></head>

<body>
<div th:replace="~{fragments/user/header :: header}"></div>
<div th:replace="~{fragments/user/feature :: feature}"></div>

<!-- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ -->
<div class="chat-wrapper">
  <!-- ì •ë³´ í‘œì‹œ ì˜ì—­ -->
  <div class="info-wrapper">
    <div id="info-content" class="info-box">
      <p class="info-placeholder">
        ì „í†µì£¼ì™€ ì–´ìš¸ë¦¬ëŠ” ì—¬í–‰ ì¼ì •ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤ ğŸ¶âœˆï¸<br>ì•„ë˜ ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”!
      </p>
    </div>

    <!-- ì €ì¥ ë²„íŠ¼ -->
    <button type="button" class="save-button">ì €ì¥</button>
  </div>


  <!-- ì±„íŒ… ì˜ì—­ -->
  <div class="chat-box">
    <div class="chat-title">AI ì£¼ë½ì´ì˜ ì£¼ë¥˜ ì¶”ì²œ</div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
      <button id="chat-send-btn">ë³´ë‚´ê¸°</button>
    </div>
  </div>
</div>

<div th:replace="~{fragments/user/footer :: footer}"></div>
<div th:replace="~{fragments/user/js :: js}"></div>
<script th:src="@{/assets/js/ai-chat/ai-chat.js}"></script>
<script th:src="@{assets/js/chatapp.js}"></script>

<!-- JS -->
<script th:inline="javascript">
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatMessages = document.getElementById('chat-messages');
  const infoBox = document.getElementById('info-content');

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    chatInput.disabled = true;
    chatSendBtn.disabled = true;

    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = text;
    chatMessages.appendChild(userMsg);
    chatInput.value = '';

    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message ai loading';
    loadingMsg.innerHTML = `
      <div class="spinner"></div>
      <span>ì£¼ë½ì´ê°€ ì£¼ë¥˜ ì°½ê³ ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤. </span>
      <div class="typing-bubble"><span></span><span></span><span></span></div>
    `;
    chatMessages.appendChild(loadingMsg);
    scrollToBottom(chatMessages);

    fetch('http://223.130.132.13:8080/alcohols/clova', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ask: text})
    })
      .then(res => res.json())
      .then(data => {
        chatMessages.removeChild(loadingMsg);
        const aiText = data.result?.finalAnswer || 'AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”.';
        typeAIMessage(aiText);
        // âš ï¸ ì´ ì‹œì ì—” ì•„ì§ ì…ë ¥ì°½ í™œì„±í™” ì•ˆ í•¨
        fetchClovaSchedule(aiText);  // ì¼ì •ê¹Œì§€ ë‹¤ ì²˜ë¦¬í•˜ê³  ë‚˜ì„œ ë‹¤ì‹œ ì—´ì–´ì•¼ í•¨
      })
      .catch(err => {
        chatMessages.removeChild(loadingMsg);
        typeAIMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      });
  }

  function typeAIMessage(message, delay = 15) {
    const aiMsg = document.createElement('div');
    aiMsg.className = 'message ai chat-bubble';
    chatMessages.appendChild(aiMsg);

    let index = 0;

    (function typeChar() {
      if (index < message.length) {
        aiMsg.textContent += message.charAt(index++);
        scrollToBottom(chatMessages);
        setTimeout(typeChar, delay);
      } else {
        // ë§í¬ ìë™ ì ìš© (ë‹¤ íƒ€ì´í•‘í•˜ê³  ë‚œ ë’¤ì—)
        aiMsg.innerHTML = linkify(aiMsg.textContent);
      }
    })();
  }

  function fetchClovaSchedule(aiText) {
    infoBox.innerHTML = `
  <p class="info-placeholder">
    ì—¬í–‰ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤   <span class="typing-bubble"><span></span><span></span><span></span>
    </span>
  </p>
`;

    fetch('http://223.130.132.13:8080/alcohols/clova2', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ask: aiText})
    })
      .then(res => res.json())
      .then(data => {
        const content = data.result?.message?.content || 'ì¶”ì²œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        typeInfoText(infoBox, content);
        // âœ… ì¼ì • ì •ë³´ ë‹¤ ë¶ˆëŸ¬ì˜¤ê³  ë‚˜ì„œ ì…ë ¥ì°½ ë‹¤ì‹œ í™œì„±í™”
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      })
      .catch(err => {
        console.error('ì¼ì • ìš”ì²­ ì˜¤ë¥˜:', err);
        infoBox.innerHTML = '<p class="info-placeholder">ì—¬í–‰ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš” ğŸ¥²</p>';
        // ì‹¤íŒ¨í–ˆì–´ë„ ë‹¤ì‹œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ í•´ì•¼ê² ì£ 
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      });
  }

  function typeInfoText(targetElement, text, delay = 15) {
    targetElement.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

    // typed-textìš© div ìƒì„±
    const typedDiv = document.createElement('div');
    typedDiv.className = 'typed-text';
    targetElement.appendChild(typedDiv);

    let index = 0;
    (function typeChar() {
      if (index < text.length) {
        // íŠ¹ìˆ˜ë¬¸ì & ê³µë°± ë³´ì¡´ì„ ìœ„í•´ textContent ì‚¬ìš©
        typedDiv.textContent += text.charAt(index++);
        typedDiv.scrollTop = typedDiv.scrollHeight; // ìŠ¤í¬ë¡¤ ë”°ë¼ê°€ê¸°
        setTimeout(typeChar, delay);
      }
    })();
  }

  function scrollToBottom(element) {
    element.scrollTop = element.scrollHeight;
  }

  // ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ URLì„ ìë™ ë§í¬ë¡œ ë³€í™˜
  function linkify(text) {
    return text.replace(
      /(https?:\/\/[^\s]+)/g,
      function (url) {
        const isImage = /\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url);
        if (isImage) {
          return `<img src="${url}" alt="ì¶”ì²œ ì´ë¯¸ì§€" style="max-width:100%; margin-top:10px; border-radius:12px;" />`;
        } else {
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        }
      }
    );
  }
  window.addEventListener('DOMContentLoaded', () => {
    typeAIMessage('ì „í†µì£¼ ì†Œë¯ˆë¦¬ì— "ì£¼ë½ì´"ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”? ê¸°ë¶„ì´ë‚˜ ë¶„ìœ„ê¸°ì— ì–´ìš¸ë¦¬ëŠ” ìˆ ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš” ğŸ¶', 50);
  });

  document.addEventListener('DOMContentLoaded', () => {
    const saveButton = document.querySelector('.save-button');

    saveButton?.addEventListener('click', () => {
      const infoTextEl = document.querySelector('#info-content .typed-text');
      const content = infoTextEl ? infoTextEl.textContent.trim() : '';

      if (!content) {
        alert('ì €ì¥í•  ì—¬í–‰ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      console.log(content)

      fetch('http://localhost:8080/alcohols/saveSchedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({content})
      })
        .then(res => {
          if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');
          return res.json();
        })
        .then(data => {
          alert('ì—¬í–‰ ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        })
        .catch(err => {
          console.error('ì €ì¥ ì˜¤ë¥˜:', err);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    });
  });

</script>

<!-- CSS -->
<style>
  body {
    background-color: #f8f5f0;
    margin: 0;
    font-family: 'Nanum Myeongjo', serif;
  }

  input[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .chat-wrapper {
    display: flex;
    gap: 24px;
    padding: 40px 20px;
    justify-content: center;
    align-items: flex-start;
    min-height: 75vh;
  }

  .save-button {
    margin-top: 10px;
    height: 60px;
    background-color: #a17f4b;
    color: #fff8e7;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    font-family: 'Nanum Myeongjo', serif;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .save-button:hover {
    background-color: #8b6a39;
  }

  .info-wrapper {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    max-width: 400px;
    height: 700px; /* ì „ì²´ ë†’ì´ ê³ ì • */
  }

  #info-content {
    flex: 1;
    max-width: 400px;
    height: 620px;
    background: linear-gradient(135deg, #fff8f0, #f0e6d2);
    border: 2px solid #c6a664;
    border-radius: 16px;
    box-shadow: 0 6px 15px rgba(198, 166, 100, 0.3);
    display: flex;
    flex-direction: column;
    font-family: 'Nanum Myeongjo', serif;
    color: #5a4427;
    user-select: text;
  }

  #info-content::before {
    content: 'ğŸ—ºï¸ ì—¬í–‰ ì •ë³´ ì œê³µ';
    background: #a17f4b;
    color: #fff8e7;
    font-weight: 700;
    font-size: 20px;
    padding: 18px 0;
    text-align: center;
    border-radius: 16px 16px 0 0;
    user-select: none;
    letter-spacing: 1px;
    box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.15);
  }

  .info-placeholder {
    flex: 1;
    padding: 24px 20px;
    font-style: italic;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.5;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 0 0 16px 16px;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.6);
    overflow-y: auto;
    color: #7a613f;
  }

  /* íƒ€ì´í•‘ë˜ëŠ” í…ìŠ¤íŠ¸ìš© ìŠ¤íƒ€ì¼ (ê¸€ì ì˜ì—­) */
  #info-content .typed-text {
    flex: 1;
    padding: 24px 20px;
    white-space: pre-wrap;
    line-height: 1.6;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 0 0 16px 16px;
    box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.7);
    overflow-y: auto;
    color: #5a4427;
    font-weight: 600;
    font-family: 'Nanum Myeongjo', serif;
    user-select: text;
    min-height: 300px;
  }

  /* ìŠ¤í¬ë¡¤ë°” ì˜ˆì˜ê²Œ */
  #info-content::-webkit-scrollbar,
  #info-content .typed-text::-webkit-scrollbar,
  .info-placeholder::-webkit-scrollbar {
    width: 8px;
  }

  #info-content::-webkit-scrollbar-thumb,
  #info-content .typed-text::-webkit-scrollbar-thumb,
  .info-placeholder::-webkit-scrollbar-thumb {
    background-color: #bba55f;
    border-radius: 8px;
    border: 2px solid transparent;
    background-clip: content-box;
  }

  .chat-box {
    flex: 2;
    max-width: 800px;
    height: 700px;
    background: #fffdf7;
    border: 1px solid #e5dcc9;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(111, 78, 55, 0.15);
  }

  .chat-title {
    background: #6f4e37;
    color: white;
    padding: 18px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    border-radius: 12px 12px 0 0;
    user-select: none;
  }

  .chat-messages {
    flex: 1;
    padding: 20px;
    background-color: #faf7f2;
    background-image: url('/assets/img/yesul/AI/bartender-ai-no-background.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 400px auto;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .chat-input-area {
    display: flex;
    padding: 8px;
    background-color: #f7f3eb;
    border-top: 1px solid #ddd;
    border-radius: 0 0 16px 16px;
  }

  .chat-bubble {
    user-select: text;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .chat-bubble a {
    color: #2b6cb0;
    text-decoration: underline;
  }

  #chat-input {
    flex: 1;
    padding: 14px 16px;
    border: 2px solid #a67c52;
    border-radius: 20px 0 0 20px;
    font-size: 15px;
    background-color: #fefcf7;
    outline: none;
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn {
    background: linear-gradient(to bottom, #b28b5e, #a07745);
    color: white;
    border: none;
    border-radius: 0 20px 20px 0;
    padding: 0 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn:hover {
    background: linear-gradient(to bottom, #8c6c45, #7a5836);
  }

  #chat-send-btn:disabled {
    background-color: #d3c4a0;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 16px;
    line-height: 1.6;
  }

  .message.user {
    align-self: flex-end;
    background-color: #dcead7;
    color: #2e4a27;
    border: 1px solid #b6d7a8;
  }

  .message.ai {
    align-self: flex-start;
    background-color: #fff1dd;
    color: #4a3b28;
    border: 1px solid #f3d2a9;
  }

  .message.ai.loading {
    font-style: italic;
    color: #888;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .typing-bubble {
    display: inline-flex; /* ë˜ëŠ” inline-block */
    gap: 6px;
    align-items: center;
    justify-content: center;
  }

  .typing-bubble span {
    width: 8px;
    height: 8px;
    background-color: #b9996d;
    border-radius: 50%;
    animation: bounce 1.3s infinite;
    opacity: 0.5;
  }

  .typing-bubble span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-bubble span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: translateY(0);
      opacity: 0.5;
    }
    40% {
      transform: translateY(-6px);
      opacity: 1;
    }
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #b28b5e;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>
</body>
</html>