<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- ê³µí†µ í—¤ë“œ -->
<head th:replace="~{fragments/user/head :: head}"></head>

<body>

<!-- ê³µí†µ í—¤ë” -->
<div th:replace="~{fragments/user/header :: header}"></div>

<!-- ê³µí†µ feature -->
<div th:replace="~{fragments/user/feature :: feature}"></div>

<!-- âœ… ì¤‘ì•™ ì±„íŒ… í™”ë©´ -->
<div class="chat-wrapper">
  <div class="chat-box">
    <div class="chat-title">AI ì£¼ë½ì´ì™€ì˜ ëŒ€í™”</div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
      <button id="chat-send-btn">ë³´ë‚´ê¸°</button>
    </div>
  </div>
</div>

<!-- ê³µí†µ í‘¸í„° -->
<div th:replace="~{fragments/user/footer :: footer}"></div>

<!-- ê³µí†µ js -->
<div th:replace="~{fragments/user/js :: js}"></div>

<!-- ì±„íŒ… js -->
<script th:src="@{/assets/js/ai-chat/ai-chat.js}"></script>
<script th:src="@{assets/js/chatapp.js}"></script>

<!-- âœ… ì±„íŒ… ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatMessages = document.getElementById('chat-messages');

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    // ì…ë ¥ ë§‰ê¸°
    chatInput.disabled = true;
    chatSendBtn.disabled = true;

    // 1. ìœ ì € ë©”ì‹œì§€ ì¶”ê°€
    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = text;
    chatMessages.appendChild(userMsg);
    chatInput.value = '';

    // 2. ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message ai loading';

    loadingMsg.innerHTML = `
    <div class="spinner"></div>
    <span>ì£¼ë½ì´ê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤ </span>
    <div class="typing-bubble">
      <span></span><span></span><span></span>
    </div>
  `;
    chatMessages.appendChild(loadingMsg);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // 3. API ìš”ì²­
    fetch('http://localhost:8080/alcohols/clova', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ask: text})
    })
      .then(response => response.json())
      .then(data => {
        // 4. ë¡œë”© ë©”ì‹œì§€ ì œê±°
        chatMessages.removeChild(loadingMsg);

        // 5. ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ (íƒ€ì´í•‘ íš¨ê³¼)
        const aiText = data.result?.finalAnswer || 'AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”.';
        typeAIMessage(aiText);

        // ì…ë ¥ í™œì„±í™”
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      })
      .catch(error => {
        chatMessages.removeChild(loadingMsg);
        typeAIMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        console.error('Error:', error);

        // ì…ë ¥ í™œì„±í™”
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      });
  }

  // âœ… íƒ€ì´í•‘ íš¨ê³¼ í•¨ìˆ˜
  function typeAIMessage(message, delay = 30) {
    const aiMsg = document.createElement('div');
    aiMsg.className = 'message ai';
    chatMessages.appendChild(aiMsg);

    let index = 0;
    function typeChar() {
      if (index < message.length) {
        aiMsg.textContent += message.charAt(index);
        index++;
        setTimeout(typeChar, delay);
      } else {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    typeChar();
  }

  // âœ… ì´ˆê¸° ì¸ì‚¬
  window.addEventListener('DOMContentLoaded', () => {
    typeAIMessage('ì „í†µì£¼ ì†Œë¯ˆë¦¬ì— "ì£¼ë½ì´"ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”? ê¸°ë¶„ì´ë‚˜ ë¶„ìœ„ê¸°ì— ì–´ìš¸ë¦¬ëŠ” ìˆ ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš” ğŸ¶', 50);
  });
</script>

<!-- âœ… ì±„íŒ… CSS -->
<style>
  /* ì „ì²´ ë°°ê²½ ë° í°íŠ¸ ì„¤ì • */
  body {
    background-color: #f8f5f0;
  }

  /* ì¤‘ì•™ ì •ë ¬ ë° ì±„íŒ… ë°•ìŠ¤ ë˜í¼ */
  .chat-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 70vh;
    margin: 40px 0;
  }

  /* ì±„íŒ… ë°•ìŠ¤ */
  .chat-box {
    width: 100%;
    max-width: 1000px;
    background: #fffdf7;
    border: 1px solid #e5dcc9;
    border-radius: 12px;
    box-shadow: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ì œëª© í—¤ë” */
  .chat-title {
    background: #6f4e37;
    color: #fffdf7;
    padding: 18px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
  }

  /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
  .chat-messages {
    padding: 20px;
    background-color: #faf7f2;
    background-image: url('/assets/img/yesul/AI/bartender-ai-no-background.png'); /* ì´ë¯¸ì§€ */
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 400px auto; /* ì‚¬ì´ì¦ˆ */
    height: 600px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* ê³µí†µ ë©”ì‹œì§€ ë°•ìŠ¤ */
  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 16px;
    line-height: 1.6;
  }

  /* ìœ ì € ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
  .message.user {
    align-self: flex-end;
    background-color: #dcead7;
    color: #2e4a27;
    border: 1px solid #b6d7a8;
  }

  /* AI ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
  .message.ai {
    align-self: flex-start;
    background-color: #fff1dd;
    color: #4a3b28;
    border: 1px solid #f3d2a9;
  }

  /* AI ë¡œë”© ë©”ì‹œì§€ */
  .message.ai.loading {
    font-style: italic;
    color: #888;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* íƒ€ì´í•‘ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ (ë²„ë¸”) */
  .typing-bubble {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: center;
  }

  .typing-bubble span {
    width: 8px;
    height: 8px;
    background-color: #b9996d;
    border-radius: 50%;
    animation: bounce 1.3s infinite;
    opacity: 0.5;
  }

  .typing-bubble span:nth-child(2) { animation-delay: 0.2s; }
  .typing-bubble span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
    40% { transform: translateY(-6px); opacity: 1; }
  }

  /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #b28b5e;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ì…ë ¥ì°½ ì˜ì—­ */
  .chat-input-area {
    display: flex;
    border-top: 1px solid #ddd;
    background-color: #f7f3eb;
    padding: 8px;
    border-radius: 0 0 16px 16px;
  }

  #chat-input {
    flex: 1;
    padding: 14px;
    border: none;
    font-size: 16px;
    outline: none;
    background-color: #fffaf4;
  }

  /* ë³´ë‚´ê¸° ë²„íŠ¼ */
  #chat-input {
    flex: 1;
    padding: 14px 16px;
    border: 2px solid #a67c52; /* ê°ˆìƒ‰ */
    border-radius: 20px 0 0 20px;
    font-size: 15px;
    background-color: #fefcf7; /* ë¯¸ìƒ‰ ì¢…ì´ ëŠë‚Œ */
    outline: none;
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn {
    background: linear-gradient(to bottom, #b28b5e, #a07745); /* ë”°ëœ»í•œ ê°ˆìƒ‰ í†¤ */
    color: white;
    border: none;
    border-radius: 0 20px 20px 0;
    padding: 0 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn:hover {
    background: linear-gradient(to bottom, #8c6c45, #7a5836);
  }

  #chat-send-btn:disabled {
    background-color: #d3c4a0;  /* ì—°í•œ ë² ì´ì§€ í†¤ */
    cursor: not-allowed;
    opacity: 0.6;
  }

</style>

</body>
</html>