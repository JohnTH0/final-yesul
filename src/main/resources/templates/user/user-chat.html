<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Chat Page</title>
  <meta charset="UTF-8">
  <style>
    #chat-message-list {
      height: 400px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>
</head>
<body>
<h1>ì±„íŒ…ë°© ìž…ìž¥</h1>

<div id="chat-message-list">
  <ul id="messageList">
    <!-- ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§ëœ ë©”ì‹œì§€ -->
    <li th:each="msg : ${messages}" th:text="${msg.messageContext}">ë©”ì‹œì§€ ë‚´ìš©</li>
  </ul>
</div>

<!-- ë©”ì‹œì§€ ìž…ë ¥ì°½ -->
<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”">
<button onclick="sendMessage()">ì „ì†¡</button>

<!-- ížˆë“  í•„ë“œ -->
<input type="hidden" id="lastMessageId" th:value="${lastMessageId}">
<input type="hidden" id="chatRoomId" th:value="${roomId}">
<input type="hidden" id="receiverId" th:value="${receiverId}">
<input type="hidden" id="userId" th:value="${userId}">

<script th:inline="javascript">
  const socket = new WebSocket("ws://" + window.location.host + "/ws/chat");

  socket.onopen = function() {
    console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
  };

  socket.onmessage = function(event) {
    const msg = JSON.parse(event.data);
    appendMessage(msg.messageContext);
    scrollToBottom();
  };

  function sendMessage() {
    const messageInput = document.getElementById("messageInput");
    const message = messageInput.value.trim();
    if (!message) return;

    const payload = {
      chatRoomId: document.getElementById("chatRoomId").value,
      userId: document.getElementById("userId").value,
      senderType: "USER",
      messageContext: message,
      messageType: "TEXT"
    };

    socket.send(JSON.stringify(payload));
    messageInput.value = "";
  }


  function appendMessage(content) {
    const messageList = document.getElementById("messageList");
    const li = document.createElement("li");
    li.textContent = content;
    messageList.appendChild(li);
  }

  function prependMessage(content) {
    const messageList = document.getElementById("messageList");
    const li = document.createElement("li");
    li.textContent = content;
    messageList.insertBefore(li, messageList.firstChild);
  }

  function scrollToBottom() {
    const chatList = document.getElementById("chat-message-list");
    chatList.scrollTop = chatList.scrollHeight;
  }

  // ì´ˆê¸° ì§„ìž… ì‹œ ë§¨ ì•„ëž˜ë¡œ ìŠ¤í¬ë¡¤
  scrollToBottom();

  // ë¬´í•œ ìŠ¤í¬ë¡¤: ìœ„ë¡œ ì˜¬ë¦´ ë•Œ ë” ê°€ì ¸ì˜¤ê¸°
  const chatList = document.getElementById("chat-message-list");
  chatList.addEventListener("scroll", function() {
    if (chatList.scrollTop === 0) {
      loadMoreMessages();
    }
  });

  function loadMoreMessages() {
    const roomId = document.getElementById("chatRoomId").value;
    const lastMessageId = document.getElementById("lastMessageId").value;

    fetch(`/api/users/chatroom/${roomId}/messages?lastMessageId=${lastMessageId}&size=20`)
      .then(res => res.json())
      .then(data => {
        if (data.content && data.content.length > 0) {
          data.content.reverse().forEach(msg => {
            prependMessage(msg.messageContext);
          });

          document.getElementById("lastMessageId").value = data.content[data.content.length - 1].messageId;
        }

        if (!data.hasNext) {
          console.log("ðŸ“Œ ë” ì´ìƒ ê°€ì ¸ì˜¬ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      })
      .catch(err => {
        console.error("ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      });
  }
</script>

</body>
</html>
